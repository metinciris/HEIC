<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HEIC → JPEG Dönüştürücü (Oto, Artımlı, ZIP)</title>
  <style>
    :root{
      --bg:#0b0e14; --panel:#131826; --muted:#8a93a6; --text:#e7eaf1;
      --accent:#7aa2f7; --accent2:#98c379; --warn:#ffb86c; --err:#ff6b6b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text);}
    .wrap{max-width:1100px; margin:32px auto; padding:0 16px;}
    .card{background:var(--panel); border-radius:var(--radius); padding:18px; box-shadow: 0 10px 30px rgba(0,0,0,.35);}
    h1{margin:0 0 6px; font-size:clamp(22px, 3vw, 34px);}
    p.muted{color:var(--muted); margin-top:6px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:14px 0}
    .btn{appearance:none; border:none; background:#222a3f; color:var(--text); padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; border:1px solid #2a3555}
    .btn.primary{background:var(--accent); color:#0b0e14; border:none}
    .btn.ready{background:linear-gradient(90deg, var(--accent), var(--accent2)); color:#0b0e14; border:none; box-shadow:0 0 0 0 rgba(122,162,247,.7); animation:pulse 1.2s ease-in-out infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(122,162,247,.55)}70%{box-shadow:0 0 0 12px rgba(122,162,247,0)}100%{box-shadow:0 0 0 0 rgba(122,162,247,0)}}
    input[type="file"]{display:none}
    label.file{display:inline-block; padding:10px 14px; border-radius:12px; border:1px dashed #31406b; cursor:pointer; background:#1a2135}
    .drop{border:2px dashed #31406b; border-radius:var(--radius); padding:22px; text-align:center; margin:12px 0; background:#0f1526}
    .drop.drag{border-color:var(--accent); background:#0e1731}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; background:#1e2742; color:var(--muted); font-size:12px}
    .progress{height:10px; width:260px; background:#111626; border-radius:999px; overflow:hidden;}
    .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2)); transition: width .25s ease}
    .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap:12px; margin-top:12px}
    .tile{background:#0e1324; border:1px solid #1e2742; border-radius:12px; overflow:hidden; display:flex; flex-direction:column}
    .thumb{aspect-ratio: 1/1; display:flex; align-items:center; justify-content:center; background:#0b1120; color:#556; font-size:12px}
    .thumb img{max-width:100%; max-height:100%; display:block}
    .meta{padding:10px; display:flex; flex-direction:column; gap:6px}
    .small{font-size:12px; color:var(--muted);}
    .status{font-size:12px; padding:2px 8px; border-radius:999px; align-self:flex-start}
    .s-wait{background:#1e2742; color:#8aa}
    .s-work{background:#2a3b6b; color:#bcd}
    .s-ok{background:#173827; color:#a6e3b8}
    .s-err{background:#3b1f26; color:#ffb3c1}
    .btn.ghost{background:transparent; border:1px solid #2a3555; color:var(--text)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>HEIC → JPEG Dönüştürücü</h1>
      <p class="muted">Seçtiğin anda otomatik dönüşüm. İsterken yeni dosyalar ekleyebilirsin. Hepsi bitince ZIP butonu renklenir.</p>

      <div class="row">
        <label class="file">
          <input id="fileInput" type="file" accept=".heic,.HEIC,image/heic" multiple />
          HEIC dosyaları seç
        </label>
        <button id="zipBtn" class="btn" disabled>Hepsini ZIP indir</button>
        <span id="status" class="badge">Hazır</span>
      </div>

      <div id="drop" class="drop">
        Dosyaları buraya sürükleyip bırakın (dönüşüm otomatik başlar). Tekrar sürükleyip daha fazlasını ekleyebilirsiniz.
      </div>

      <div class="row">
        <label>Kalite: <input id="quality" type="range" min="40" max="100" value="90" /> <span id="qOut">90</span>%</label>
        <div class="progress"><div id="bar" class="bar"></div></div>
      </div>

      <div id="grid" class="grid" aria-live="polite"></div>
    </div>
  </div>

  <!-- Libs: heic2any + JSZip + FileSaver -->
  <script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const drop = document.getElementById('drop');
    const zipBtn = document.getElementById('zipBtn');
    const qRange = document.getElementById('quality');
    const qOut = document.getElementById('qOut');
    const statusEl = document.getElementById('status');
    const bar = document.getElementById('bar');
    const grid = document.getElementById('grid');

    qOut.textContent = qRange.value;
    qRange.addEventListener('input', ()=> qOut.textContent = qRange.value);

    // Durumlar: wait -> work -> ok/err
    // Kimlik için name+size+lastModified hash'i kullanıyoruz (aynı dosyayı iki kez eklemeyi önlemek için).
    const items = new Map(); // id -> {file, base, status, jpegBlob, el, imgEl, stEl, dlBtn, outName}
    let processing = false;

    function makeId(f){
      return `${f.name}__${f.size}__${f.lastModified}`;
    }
    function humanSize(n){
      const u=['B','KB','MB','GB']; let i=0, v=n;
      while(v>1024 && i<u.length-1){ v/=1024; i++; }
      return v.toFixed(v<10 && i>0 ? 1 : 0)+' '+u[i];
    }
    function makeTile(it){
      const tile = document.createElement('div'); tile.className='tile';
      const th = document.createElement('div'); th.className='thumb'; th.textContent='Önizleme yok';
      const img = document.createElement('img'); img.style.display='none'; th.appendChild(img); tile.appendChild(th);
      const meta = document.createElement('div'); meta.className='meta';
      const nameEl = document.createElement('div'); nameEl.style.fontWeight='600'; nameEl.textContent=it.file.name; nameEl.title=it.file.name;
      const sizeEl = document.createElement('div'); sizeEl.className='small'; sizeEl.textContent=humanSize(it.file.size);
      const st = document.createElement('span'); st.className='status s-wait'; st.textContent='Beklemede';
      const links = document.createElement('div'); links.style.display='flex'; links.style.gap='8px'; links.style.flexWrap='wrap';
      const dlBtn = document.createElement('button'); dlBtn.className='btn ghost'; dlBtn.textContent='İndir (JPEG)'; dlBtn.disabled=true;

      links.appendChild(dlBtn);
      meta.appendChild(nameEl); meta.appendChild(sizeEl); meta.appendChild(st); meta.appendChild(links);
      tile.appendChild(meta);

      it.el = tile; it.imgEl = img; it.stEl = st; it.dlBtn = dlBtn;
      return tile;
    }

    function addFiles(list){
      const files = Array.from(list).filter(f => /\.heic$/i.test(f.name) || f.type === 'image/heic');
      let added = 0;
      for (const f of files){
        const id = makeId(f);
        if (items.has(id)) continue; // aynı dosyayı tekrar ekleme
        const base = f.name.replace(/\.[^.]+$/,'');
        const it = { id, file:f, base, status:'wait', jpegBlob:null, outName: base + '.jpeg', el:null, imgEl:null, stEl:null, dlBtn:null };
        items.set(id, it);
        grid.appendChild(makeTile(it));
        added++;
      }
      if (added > 0){
        statusEl.textContent = `Eklendi: ${added} dosya (toplam ${items.size})`;
        kickOff(); // otomatik başlat / devam ettir
      }
    }

    function updateProgress(){
      const total = items.size;
      const done = Array.from(items.values()).filter(x => x.status === 'ok').length;
      const worked = Array.from(items.values()).filter(x => x.status !== 'wait').length;
      const pct = total ? Math.round((worked/total)*100) : 0;
      bar.style.width = pct + '%';

      // Hepsi başarıyla tamamlandı mı?
      const allDone = (done === total) && total > 0;
      zipBtn.disabled = !allDone;
      zipBtn.classList.toggle('ready', allDone); // renklensin
      if (allDone){
        statusEl.textContent = `Bitti: ${done}/${total}`;
      }
    }

    async function convertOne(it){
      it.status = 'work';
      it.stEl.className = 'status s-work';
      it.stEl.textContent = 'Dönüştürülüyor…';
      try{
        const jpegBlob = await window.heic2any({
          blob: it.file,
          toType: 'image/jpeg',
          quality: Number(qRange.value)/100
        });
        it.jpegBlob = jpegBlob;
        it.status = 'ok';
        it.stEl.className = 'status s-ok';
        it.stEl.textContent = 'Hazır';

        // Önizleme (JPEG üzerinden)
        const url = URL.createObjectURL(jpegBlob);
        it.imgEl.src = url;
        it.imgEl.onload = ()=>{
          it.imgEl.previousSibling?.remove?.(); // "Önizleme yok" yazısını kaldır
          it.imgEl.style.display = 'block';
        };

        // Tek tek indir
        it.dlBtn.disabled = false;
        it.dlBtn.onclick = () => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(jpegBlob);
          a.download = it.outName;
          document.body.appendChild(a);
          a.click();
          setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1200);
        };

      }catch(err){
        it.status = 'err';
        it.stEl.className = 'status s-err';
        it.stEl.textContent = 'Hata: ' + (err?.message || err);
        console.error('Convert error', err);
      }finally{
        updateProgress();
      }
    }

    async function processLoop(){
      processing = true;
      while(true){
        // sıradaki bekleyen öğeyi bul
        const next = Array.from(items.values()).find(x => x.status === 'wait');
        if (!next) break;
        await convertOne(next);
      }
      processing = false;
      updateProgress();
    }

    function kickOff(){
      if (!processing) {
        processLoop();
      } // processing true ise, mevcut döngü bitince sıradakiler zaten işlenecek
    }

    // Girişler
    fileInput.addEventListener('change', e => {
      if (e.target.files?.length) addFiles(e.target.files);
      // yeni seçimden sonra input'u sıfırla ki aynı dosyayı tekrar seçince event tekrar tetiklensin
      e.target.value = '';
    });

    ;['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, (e)=>{
      e.preventDefault(); e.stopPropagation(); drop.classList.add('drag');
    }));
    ;['dragleave','drop'].forEach(ev => drop.addEventListener(ev, (e)=>{
      e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag');
    }));
    drop.addEventListener('drop', (e)=>{
      if (e.dataTransfer?.files?.length) addFiles(e.dataTransfer.files);
    });

    // ZIP indirme — tümü "ok" olduğunda renklenecek
    zipBtn.addEventListener('click', async ()=>{
      const all = Array.from(items.values());
      const oks = all.filter(x => x.status === 'ok');
      if (oks.length !== all.length || all.length === 0) return; // güvenlik
      zipBtn.disabled = true;
      statusEl.textContent = 'ZIP hazırlanıyor…';
      const zip = new JSZip();
      oks.forEach(it => zip.file(it.outName, it.jpegBlob));
      const blob = await zip.generateAsync({type:'blob'});
      saveAs(blob, 'heic_to_jpeg.zip');
      statusEl.textContent = `ZIP indirildi (${oks.length} dosya)`;
      zipBtn.disabled = false;
    });
  </script>
</body>
</html>
